import tkinter as tk
from tkinter import ttk, messagebox
from db import BancoDeDados

class EstoqueGUI:
    def __init__(self, root):
        self.banco = BancoDeDados()
        self.root = root
        self.root.title("Sistema de Estoque - Prova 2")
        self.root.geometry("800x600")

        # --- Variáveis ---
        self.var_id = tk.StringVar()
        self.var_nome = tk.StringVar()
        self.var_tipo = tk.StringVar()
        self.var_valor = tk.DoubleVar()
        self.var_marca = tk.StringVar()
        self.var_categoria = tk.StringVar()

        # --- Layout ---
        self.criar_widgets()
        self.carregar_dados()

    def criar_widgets(self):
        # Frame de Formulário
        frame_form = tk.LabelFrame(self.root, text="Dados do Produto")
        frame_form.pack(fill="x", padx=10, pady=5)

        tk.Label(frame_form, text="Nome:").grid(row=0, column=0, padx=5, pady=5)
        tk.Entry(frame_form, textvariable=self.var_nome).grid(row=0, column=1)

        tk.Label(frame_form, text="Tipo:").grid(row=0, column=2, padx=5, pady=5)
        tk.Entry(frame_form, textvariable=self.var_tipo).grid(row=0, column=3)

        tk.Label(frame_form, text="Valor:").grid(row=1, column=0, padx=5, pady=5)
        tk.Entry(frame_form, textvariable=self.var_valor).grid(row=1, column=1)

        tk.Label(frame_form, text="Marca:").grid(row=1, column=2, padx=5, pady=5)
        tk.Entry(frame_form, textvariable=self.var_marca).grid(row=1, column=3)

        tk.Label(frame_form, text="Categoria:").grid(row=2, column=0, padx=5, pady=5)
        
        # Carregar categorias do banco para o Combobox
        cats = self.banco.listar_categorias() # Retorna lista de tuplas (id, nome)
        self.dict_categorias = {nome: id_cat for id_cat, nome in cats} # Dicionário para buscar ID pelo nome
        self.combo_cat = ttk.Combobox(frame_form, textvariable=self.var_categoria, values=list(self.dict_categorias.keys()))
        self.combo_cat.grid(row=2, column=1)

        # Botões
        frame_botoes = tk.Frame(self.root)
        frame_botoes.pack(pady=10)
        
        tk.Button(frame_botoes, text="Adicionar", command=self.adicionar, bg="#d9fdd3").pack(side="left", padx=5)
        tk.Button(frame_botoes, text="Atualizar Selecionado", command=self.atualizar, bg="#fff2cc").pack(side="left", padx=5)
        tk.Button(frame_botoes, text="Excluir Selecionado", command=self.excluir, bg="#f4cccc").pack(side="left", padx=5)
        tk.Button(frame_botoes, text="Limpar Campos", command=self.limpar_campos).pack(side="left", padx=5)

        # Lista (Treeview)
        self.tree = ttk.Treeview(self.root, columns=("ID", "Nome", "Tipo", "Valor", "Marca", "Categoria"), show="headings")
        self.tree.heading("ID", text="ID")
        self.tree.heading("Nome", text="Nome")
        self.tree.heading("Tipo", text="Tipo")
        self.tree.heading("Valor", text="Valor")
        self.tree.heading("Marca", text="Marca")
        self.tree.heading("Categoria", text="Categoria")
        
        # Configurar largura das colunas
        for col in self.tree["columns"]:
            self.tree.column(col, width=100)

        self.tree.pack(fill="both", expand=True, padx=10, pady=10)
        self.tree.bind("<<TreeviewSelect>>", self.ao_selecionar)

    def carregar_dados(self):
        # Limpa a tabela atual
        for row in self.tree.get_children():
            self.tree.delete(row)
        
        # Busca do banco
        produtos = self.banco.listar_produtos()
        for p in produtos:
            self.tree.insert("", "end", values=p)

    def adicionar(self):
        try:
            nome = self.var_nome.get()
            if not nome: raise ValueError("Nome é obrigatório")
            
            cat_nome = self.var_categoria.get()
            cat_id = self.dict_categorias.get(cat_nome)
            
            if not cat_id: raise ValueError("Selecione uma categoria válida")

            status, msg = self.banco.inserir_produto(
                nome, self.var_tipo.get(), self.var_valor.get(), self.var_marca.get(), cat_id
            )
            
            messagebox.showinfo("Info", msg)
            if status:
                self.limpar_campos()
                self.carregar_dados()
        except ValueError as ve:
            messagebox.showwarning("Atenção", str(ve))
        except Exception as e:
            messagebox.showerror("Erro", str(e))

    def ao_selecionar(self, event):
        selecionado = self.tree.selection()
        if selecionado:
            item = self.tree.item(selecionado[0])
            valores = item['values']
            # Preenche os campos
            self.var_id.set(valores[0])
            self.var_nome.set(valores[1])
            self.var_tipo.set(valores[2])
            self.var_valor.set(valores[3])
            self.var_marca.set(valores[4])
            self.var_categoria.set(valores[5])

    def atualizar(self):
        try:
            id_prod = self.var_id.get()
            if not id_prod: return
            
            cat_nome = self.var_categoria.get()
            cat_id = self.dict_categorias.get(cat_nome)

            if self.banco.atualizar_produto(id_prod, self.var_nome.get(), self.var_tipo.get(), 
                                            self.var_valor.get(), self.var_marca.get(), cat_id):
                messagebox.showinfo("Sucesso", "Produto atualizado!")
                self.limpar_campos()
                self.carregar_dados()
            else:
                messagebox.showerror("Erro", "Erro ao atualizar.")
        except Exception as e:
            messagebox.showerror("Erro", f"Dados inválidos: {e}")

    def excluir(self):
        id_prod = self.var_id.get()
        if not id_prod: return
        
        if messagebox.askyesno("Confirmar", "Deseja excluir este produto?"):
            if self.banco.excluir_produto(id_prod):
                messagebox.showinfo("Sucesso", "Produto excluído!")
                self.limpar_campos()
                self.carregar_dados()

    def limpar_campos(self):
        self.var_id.set("")
        self.var_nome.set("")
        self.var_tipo.set("")
        self.var_valor.set(0.0)
        self.var_marca.set("")
        self.var_categoria.set("")
